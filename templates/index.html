<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Docker AI Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="dockerAI()">
        
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">MCP Docker AI Interface</h1>
            <p class="text-gray-600">Manage Docker containers with AI assistance</p>
        </header>

        <!-- AI Provider Configuration -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">ü§ñ AI Providers</h2>
            
            <!-- Add Provider Form -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-medium mb-3">Add AI Provider</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input 
                        x-model="newProvider.name" 
                        placeholder="Provider Name (e.g., openai)" 
                        class="px-3 py-2 border rounded-md"
                    />
                    <input 
                        x-model="newProvider.api_key" 
                        placeholder="API Key" 
                        type="password"
                        class="px-3 py-2 border rounded-md"
                    />
                    <input 
                        x-model="newProvider.base_url" 
                        placeholder="API Base URL" 
                        class="px-3 py-2 border rounded-md"
                    />
                    <input 
                        x-model="newProvider.model" 
                        placeholder="Model (e.g., gpt-4)" 
                        class="px-3 py-2 border rounded-md"
                    />
                </div>
                <button 
                    @click="addProvider()" 
                    class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"
                >
                    Add Provider
                </button>
            </div>

            <!-- Provider List -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="(provider, name) in providers" :key="name">
                    <div class="border rounded-lg p-4 bg-white">
                        <h4 class="font-medium text-lg" x-text="provider.name"></h4>
                        <p class="text-sm text-gray-600" x-text="provider.model"></p>
                        <p class="text-xs text-gray-500" x-text="provider.base_url"></p>
                        <button 
                            @click="removeProvider(name)"
                            class="mt-2 bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600"
                        >
                            Remove
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Docker Management -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Container Management -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">üê≥ Docker Containers</h2>
                
                <!-- Create Container -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium mb-3">Create Container</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <select x-model="newContainer.image" class="px-3 py-2 border rounded-md">
                            <option value="">Select Image</option>
                            <template x-for="image in availableImages" :key="image">
                                <option :value="image" x-text="image"></option>
                            </template>
                        </select>
                        <input 
                            x-model="newContainer.name" 
                            placeholder="Container Name (optional)" 
                            class="px-3 py-2 border rounded-md"
                        />
                    </div>
                    <div class="mt-3 flex items-center gap-4">
                        <label class="flex items-center" x-show="gpuStatus.gpu_available">
                            <input 
                                type="checkbox" 
                                x-model="newContainer.use_gpu" 
                                class="mr-2"
                            />
                            Enable GPU Support
                        </label>
                        <span x-show="!gpuStatus.gpu_available" class="text-sm text-gray-500">
                            GPU not available
                        </span>
                    </div>
                    <button 
                        @click="createContainer()" 
                        class="mt-3 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"
                        :disabled="!newContainer.image"
                    >
                        Create Container
                    </button>
                </div>

                <!-- Container List -->
                <div class="space-y-3">
                    <template x-for="container in containers" :key="container.id">
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-medium" x-text="container.name"></h4>
                                    <p class="text-sm text-gray-600" x-text="container.image"></p>
                                </div>
                                <span 
                                    class="px-2 py-1 rounded-full text-xs font-medium"
                                    :class="container.status === 'running' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                    x-text="container.status"
                                ></span>
                            </div>
                            <p class="text-xs text-gray-500 mb-3" x-text="'ID: ' + container.id"></p>
                            
                            <!-- Command Input -->
                            <div class="flex gap-2">
                                <input 
                                    :x-model="`containerCommands.${container.id}`"
                                    placeholder="Enter command..." 
                                    class="flex-1 px-2 py-1 border rounded text-sm"
                                    @keyup.enter="executeCommand(container.id)"
                                />
                                <button 
                                    @click="executeCommand(container.id)"
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                >
                                    Execute
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Docker Scout Security -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">üîí Docker Scout Security</h2>
                
                <div class="space-y-4">
                    <div>
                        <select x-model="securityScan.image" class="w-full px-3 py-2 border rounded-md mb-3">
                            <option value="">Select Image to Scan</option>
                            <template x-for="image in availableImages" :key="image">
                                <option :value="image" x-text="image"></option>
                            </template>
                        </select>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button 
                                @click="scanVulnerabilities()" 
                                class="bg-yellow-500 text-white px-3 py-2 rounded text-sm hover:bg-yellow-600"
                                :disabled="!securityScan.image"
                            >
                                Scan Vulnerabilities
                            </button>
                            <button 
                                @click="getRecommendations()" 
                                class="bg-purple-500 text-white px-3 py-2 rounded text-sm hover:bg-purple-600"
                                :disabled="!securityScan.image"
                            >
                                Get Recommendations
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Chat Interface -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">üí¨ AI Chat</h2>
            
            <!-- Provider Selection -->
            <div class="mb-4 flex gap-4 items-center">
                <select x-model="selectedProvider" class="px-3 py-2 border rounded-md">
                    <option value="">Select AI Provider</option>
                    <template x-for="(provider, name) in providers" :key="name">
                        <option :value="name" x-text="provider.name"></option>
                    </template>
                </select>
                
                <label class="flex items-center">
                    <input 
                        type="checkbox" 
                        x-model="includeDockerContext" 
                        class="mr-2"
                    />
                    Include Docker Context
                </label>

                <button 
                    @click="clearChatHistory()" 
                    class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
                >
                    Clear History
                </button>
            </div>

            <!-- Chat Messages -->
            <div class="border rounded-lg p-4 h-64 overflow-y-auto mb-4 bg-gray-50">
                <template x-for="message in chatHistory" :key="message.timestamp">
                    <div class="mb-3">
                        <div 
                            class="inline-block px-3 py-2 rounded-lg max-w-xs lg:max-w-md"
                            :class="message.role === 'user' ? 'bg-blue-500 text-white ml-auto' : 'bg-white border'"
                        >
                            <p class="text-sm" x-text="message.content"></p>
                            <p 
                                class="text-xs mt-1 opacity-75" 
                                x-text="new Date(message.timestamp).toLocaleTimeString()"
                            ></p>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Message Input -->
            <div class="flex gap-2">
                <input 
                    x-model="chatMessage" 
                    placeholder="Type your message..." 
                    class="flex-1 px-3 py-2 border rounded-md"
                    @keyup.enter="sendMessage()"
                />
                <button 
                    @click="sendMessage()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"
                    :disabled="!selectedProvider || !chatMessage.trim()"
                >
                    Send
                </button>
            </div>
        </div>

        <!-- Operation Logs -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">üìã Operation Logs</h2>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                <template x-for="operation in operationLogs" :key="operation.timestamp">
                    <div class="border-l-4 border-blue-500 pl-4 py-2 bg-gray-50">
                        <h4 class="font-medium" x-text="operation.operation"></h4>
                        <p class="text-sm text-gray-600" x-text="JSON.stringify(operation.parameters)"></p>
                        <p class="text-xs text-gray-500" x-text="operation.result"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function dockerAI() {
            return {
                // Data
                providers: {},
                containers: [],
                availableImages: [],
                chatHistory: [],
                operationLogs: [],
                containerCommands: {},
                gpuStatus: {
                    gpu_available: false,
                    status: ''
                },
                
                // Form models
                newProvider: {
                    name: '',
                    api_key: '',
                    base_url: '',
                    model: ''
                },
                newContainer: {
                    image: '',
                    name: '',
                    use_gpu: false
                },
                securityScan: {
                    image: ''
                },
                
                // Chat
                selectedProvider: '',
                chatMessage: '',
                includeDockerContext: false,
                
                // Initialize
                async init() {
                    await this.loadProviders();
                    await this.loadContainers();
                    await this.loadImages();
                    await this.loadGpuStatus();
                    await this.loadChatHistory();
                    await this.loadOperationLogs();
                },
                
                // Provider Management
                async addProvider() {
                    if (!this.newProvider.name || !this.newProvider.api_key) return;
                    
                    try {
                        const response = await fetch('/api/providers', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.newProvider)
                        });
                        
                        if (response.ok) {
                            await this.loadProviders();
                            this.newProvider = {name: '', api_key: '', base_url: '', model: ''};
                        }
                    } catch (error) {
                        console.error('Error adding provider:', error);
                    }
                },
                
                async removeProvider(name) {
                    try {
                        await fetch(`/api/providers/${name}`, {method: 'DELETE'});
                        await this.loadProviders();
                    } catch (error) {
                        console.error('Error removing provider:', error);
                    }
                },
                
                async loadProviders() {
                    try {
                        const response = await fetch('/api/providers');
                        this.providers = await response.json();
                    } catch (error) {
                        console.error('Error loading providers:', error);
                    }
                },
                
                // Container Management
                async createContainer() {
                    if (!this.newContainer.image) return;
                    
                    try {
                        const params = new URLSearchParams();
                        params.append('image', this.newContainer.image);
                        if (this.newContainer.name) params.append('name', this.newContainer.name);
                        if (this.newContainer.use_gpu) params.append('use_gpu', 'true');
                        
                        await fetch('/api/docker/containers?' + params, {method: 'POST'});
                        await this.loadContainers();
                        this.newContainer = {image: '', name: '', use_gpu: false};
                    } catch (error) {
                        console.error('Error creating container:', error);
                    }
                },
                
                async executeCommand(containerId) {
                    const command = this.containerCommands[containerId];
                    if (!command) return;
                    
                    try {
                        const params = new URLSearchParams();
                        params.append('command', command);
                        
                        const response = await fetch(`/api/docker/containers/${containerId}/execute?${params}`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        console.log('Command result:', result);
                        this.containerCommands[containerId] = '';
                        await this.loadOperationLogs();
                    } catch (error) {
                        console.error('Error executing command:', error);
                    }
                },
                
                async loadContainers() {
                    try {
                        const response = await fetch('/api/docker/containers');
                        const data = await response.json();
                        this.containers = data.containers || [];
                    } catch (error) {
                        console.error('Error loading containers:', error);
                    }
                },
                
                async loadImages() {
                    try {
                        const response = await fetch('/api/docker/images');
                        const data = await response.json();
                        this.availableImages = data.images || [];
                    } catch (error) {
                        console.error('Error loading images:', error);
                    }
                },
                
                async loadGpuStatus() {
                    try {
                        const response = await fetch('/api/docker/gpu-status');
                        const data = await response.json();
                        this.gpuStatus = data;
                    } catch (error) {
                        console.error('Error loading GPU status:', error);
                    }
                },
                
                // Security
                async scanVulnerabilities() {
                    if (!this.securityScan.image) return;
                    
                    try {
                        const response = await fetch(`/api/docker/scout/scan/${this.securityScan.image}`, {
                            method: 'POST'
                        });
                        const result = await response.json();
                        console.log('Security scan result:', result);
                    } catch (error) {
                        console.error('Error scanning vulnerabilities:', error);
                    }
                },
                
                async getRecommendations() {
                    if (!this.securityScan.image) return;
                    
                    try {
                        const response = await fetch(`/api/docker/scout/recommendations/${this.securityScan.image}`, {
                            method: 'POST'
                        });
                        const result = await response.json();
                        console.log('Recommendations:', result);
                    } catch (error) {
                        console.error('Error getting recommendations:', error);
                    }
                },
                
                // Chat
                async sendMessage() {
                    if (!this.selectedProvider || !this.chatMessage.trim()) return;
                    
                    try {
                        const params = new URLSearchParams();
                        params.append('provider_name', this.selectedProvider);
                        params.append('message', this.chatMessage);
                        params.append('include_docker_context', this.includeDockerContext);
                        
                        const response = await fetch('/api/chat?' + params, {method: 'POST'});
                        const result = await response.json();
                        
                        this.chatMessage = '';
                        await this.loadChatHistory();
                    } catch (error) {
                        console.error('Error sending message:', error);
                    }
                },
                
                async loadChatHistory() {
                    try {
                        const response = await fetch('/api/chat/history');
                        const data = await response.json();
                        this.chatHistory = data.messages || [];
                    } catch (error) {
                        console.error('Error loading chat history:', error);
                    }
                },
                
                async clearChatHistory() {
                    try {
                        await fetch('/api/chat/history', {method: 'DELETE'});
                        this.chatHistory = [];
                    } catch (error) {
                        console.error('Error clearing chat history:', error);
                    }
                },
                
                async loadOperationLogs() {
                    try {
                        const response = await fetch('/api/operations');
                        const data = await response.json();
                        this.operationLogs = data.operations || [];
                    } catch (error) {
                        console.error('Error loading operation logs:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>